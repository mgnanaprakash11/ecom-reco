with source as (
  select
    id,
    tenant_id,
    data_upload_batch_id,
    row_number,
    shopify_order_id,
    name,
    email,
    financial_status,
    fulfillment_status,
    paid_at,
    fulfilled_at,
    accepts_marketing,
    currency,
    subtotal,
    shipping,
    taxes,
    total,
    discount_code,
    discount_amount,
    shipping_method,
    order_created_at,
    lineitem_quantity,
    lineitem_name,
    lineitem_price,
    lineitem_compare_at_price,
    lineitem_sku,
    lineitem_requires_shipping,
    lineitem_taxable,
    lineitem_fulfillment_status,
    billing_name,
    billing_street,
    billing_address1,
    billing_address2,
    billing_company,
    billing_city,
    billing_zip,
    billing_province,
    billing_country,
    billing_phone,
    shipping_name,
    shipping_street,
    shipping_address1,
    shipping_address2,
    shipping_company,
    shipping_city,
    shipping_zip,
    shipping_province,
    shipping_country,
    shipping_phone,
    notes,
    note_attributes,
    cancelled_at,
    payment_method,
    payment_reference,
    refunded_amount,
    vendor,
    outstanding_balance,
    employee,
    location,
    device_id,
    tags,
    risk_level,
    source,
    lineitem_discount,
    tax_1_name,
    tax_1_value,
    tax_2_name,
    tax_2_value,
    tax_3_name,
    tax_3_value,
    tax_4_name,
    tax_4_value,
    tax_5_name,
    tax_5_value,
    phone,
    receipt_number,
    duties,
    billing_province_name,
    shipping_province_name,
    payment_id,
    payment_terms_name,
    next_payment_due_at,
    payment_references,
    created_at
  from {{ source('raw', 'shopify_orders') }}
),
typed as (
  select
    id,
    tenant_id,
    data_upload_batch_id,
    row_number,
    shopify_order_id,
    name,
    email,
    financial_status,
    fulfillment_status,
    nullif(order_created_at, '')::timestamptz as order_created_at,
    nullif(paid_at, '')::timestamptz as paid_at,
    nullif(fulfilled_at, '')::timestamptz as fulfilled_at,
    nullif(cancelled_at, '')::timestamptz as cancelled_at,
    case
      when lower(nullif(accepts_marketing, '')) in ('yes', 'true', '1') then true
      when lower(nullif(accepts_marketing, '')) in ('no', 'false', '0') then false
      else null
    end as accepts_marketing,
    currency,
    nullif(subtotal, '')::numeric as subtotal_amount,
    nullif(shipping, '')::numeric as shipping_amount,
    nullif(taxes, '')::numeric as tax_amount,
    nullif(total, '')::numeric as total_amount,
    discount_code,
    nullif(discount_amount, '')::numeric as discount_amount,
    shipping_method,
    lineitem_name,
    nullif(lineitem_price, '')::numeric as lineitem_unit_price,
    nullif(lineitem_compare_at_price, '')::numeric as lineitem_compare_at_price,
    nullif(lineitem_discount, '')::numeric as lineitem_discount_amount,
    nullif(lineitem_quantity, '')::integer as lineitem_quantity,
    lineitem_sku,
    nullif(lineitem_requires_shipping, '')::boolean as lineitem_requires_shipping,
    nullif(lineitem_taxable, '')::boolean as lineitem_taxable,
    lineitem_fulfillment_status,
    billing_name,
    billing_street,
    billing_address1,
    billing_address2,
    billing_company,
    billing_city,
    billing_zip,
    billing_province,
    billing_country,
    billing_phone,
    shipping_name,
    shipping_street,
    shipping_address1,
    shipping_address2,
    shipping_company,
    shipping_city,
    shipping_zip,
    shipping_province,
    shipping_country,
    shipping_phone,
    notes,
    note_attributes,
    payment_method,
    payment_reference,
    nullif(refunded_amount, '')::numeric as refunded_amount,
    vendor,
    nullif(outstanding_balance, '')::numeric as outstanding_balance,
    employee,
    location,
    device_id,
    tags,
    risk_level,
    source,
    tax_1_name,
    nullif(tax_1_value, '')::numeric as tax_1_amount,
    tax_2_name,
    nullif(tax_2_value, '')::numeric as tax_2_amount,
    tax_3_name,
    nullif(tax_3_value, '')::numeric as tax_3_amount,
    tax_4_name,
    nullif(tax_4_value, '')::numeric as tax_4_amount,
    tax_5_name,
    nullif(tax_5_value, '')::numeric as tax_5_amount,
    phone,
    receipt_number,
    nullif(duties, '')::numeric as duties_amount,
    billing_province_name,
    shipping_province_name,
    payment_id,
    payment_terms_name,
    nullif(next_payment_due_at, '')::timestamptz as next_payment_due_at,
    payment_references,
    created_at
  from source
)
select
  typed.*,
  coalesce(typed.lineitem_quantity, 0) * coalesce(typed.lineitem_unit_price, 0) as lineitem_extended_price
from typed;
