with source as (
  select
    id,
    tenant_id,
    data_upload_batch_id,
    row_number,
    shopify_order_id,
    order_created_at,
    paid_at,
    fulfilled_at,
    cancelled_at,
    financial_status,
    fulfillment_status,
    accepts_marketing,
    currency,
    subtotal_amount,
    shipping_amount,
    tax_amount,
    discount_code,
    discount_amount,
    total_amount,
    refunded_amount,
    outstanding_balance,
    shipping_method,
    lineitem_name,
    lineitem_sku,
    lineitem_quantity,
    lineitem_unit_price,
    lineitem_extended_price,
    lineitem_compare_at_price,
    lineitem_discount_amount,
    lineitem_requires_shipping,
    lineitem_taxable,
    lineitem_fulfillment_status,
    vendor,
    payment_method,
    payment_reference,
    payment_id,
    payment_terms_name,
    next_payment_due_at,
    payment_references,
    name,
    email,
    phone,
    notes,
    note_attributes,
    tags,
    risk_level,
    source,
    billing_name,
    billing_street,
    billing_address1,
    billing_address2,
    billing_company,
    billing_city,
    billing_zip,
    billing_province,
    billing_country,
    billing_phone,
    billing_province_name,
    shipping_name,
    shipping_street,
    shipping_address1,
    shipping_address2,
    shipping_company,
    shipping_city,
    shipping_zip,
    shipping_province,
    shipping_country,
    shipping_phone,
    shipping_province_name,
    tax_1_name,
    tax_1_amount,
    tax_2_name,
    tax_2_amount,
    tax_3_name,
    tax_3_amount,
    tax_4_name,
    tax_4_amount,
    tax_5_name,
    tax_5_amount,
    duties_amount,
    employee,
    location,
    device_id,
    receipt_number,
    created_at
  from {{ ref('stg_shopify_orders') }}
),
metrics as (
  select
    source.*,
    coalesce(source.subtotal_amount, 0) - coalesce(source.discount_amount, 0) as subtotal_net_amount,
    coalesce(source.total_amount, 0) - coalesce(source.refunded_amount, 0) as net_sales_amount,
    coalesce(source.lineitem_extended_price, 0) - coalesce(source.lineitem_discount_amount, 0) as lineitem_net_amount,
    coalesce(source.lineitem_compare_at_price, 0) - coalesce(source.lineitem_unit_price, 0) as lineitem_compare_gap,
    coalesce(source.tax_1_amount, 0)
      + coalesce(source.tax_2_amount, 0)
      + coalesce(source.tax_3_amount, 0)
      + coalesce(source.tax_4_amount, 0)
      + coalesce(source.tax_5_amount, 0) as total_tax_components_amount
  from source
)
select
  metrics.*,
  metrics.net_sales_amount - coalesce(metrics.shipping_amount, 0) as net_sales_after_shipping
from metrics;
